---
title: "hCoCena showcase (main)"
author: "Marie Oestreich"
date: "22 5 2022"
output:
  html_document: default
  pdf_document: default
---


# Introduction
  This markdown, in combination with the markdown 'hcocena_satellite_showcase.Rmd' illustrate how to use the hCoCena tool on a small example using two data sets.
Both data sets measure the transcription profiles of Macrophages when treated with Interferon Gamma, Interleukin-4 or at Baseline (untreated). 
However, one data set was generated using RNA-Sequencing, while the other was generated using a Microarray.

The main-Markdown contains the base workflow of hCoCena. For a fully functional analysis, these steps are mandatory unless declared otherwise (flagged with OPTIONAL). Feel free to expand upon this base analysis with the provided satellite functions or your custom scripts. You will find detailed information on the satellite functions as well as intermediate outputs that you can use for your custom analyses in the repository's Wiki (https://github.com/MarieOestreich/hCoCena/wiki).


# Pre-Integration Phase
  This part includes all the steps that lead up to the actual integration procedure of the data sets.

## load hCoCena package

  First, we are going to load the hCoCena R-package. For information on how to download and install the package, please refer to the 'install_hcocena.R' script that your can find int the Github repository.

```{r}
library(hcocena)
```


## create hCoCena-Object

  Now, we will create the 'hcobject'. This is an object structure specifically designed for the hCoCena analysis and it will store all intermediate results of the analysis in a unified structure. For more information on the structure, please refer to the Wiki: https://github.com/MarieOestreich/hCoCena/wiki/Structure-of-the-hcobject.
  The object will automatically be instantiated by running the function below, no parameters need to be set. 

```{r}
init_object()
```


## Working directory setup

  In this step, we will indicate to hCoCena where it can find everything we need for the analysis: Our gene expression data (a.k.a. count data), our meta data (a.k.a. annotation), and our reference files. These will be used for example for highlighting transcription factors or doing an enrichment analysis. For more information on the different files and how to pass them to the function, please refer to the following section of the wiki: https://github.com/MarieOestreich/hCoCena/wiki/General-Backgroud-Information#count-files-annotation-files--reference-files.
  
  In this case, we will not read the expression data and the annotation from files, but instead use an R-environment that we have prepared for this showcase. You can find the environment in the repository's showcase folder, it is named 'start_envo.RData'. After downloading, we can load the environment like this:
  
```{r}
# You will have to adapt the path depending on where you saved the downloaded file:


load("~/Work/Repos/hCoCena/showcase/start_envo.RData")

```
  

  Because we are not reading our data from file, we will set the directory for the count data ('dir_count_data'), as well as for the annotation ('dir_annotation') to FALSE.
My reference files are stored at "~/Work/hcocena/reference_files/", hence the parameter 'dir_reference_files' is set accordingly. The files can be downloaded from the Github repository folder named 'reference files', after downloading, the path must be adapted according to where it was downloaded to.

  Lastly, we define a directory where we want to create our analysis folder. I have a folder ("~/Work/hcocena/analyses/") where I store the results for my different analyses. In this folder, hCoCena will create a new folder specfically for this analysis and store all plots and other outputs there.


```{r}

init_wd(dir_count_data = FALSE,
        dir_annotation = FALSE,
        dir_reference_files = "~/Work/hcocena/reference_files/", #the folder that contains the reference files
        dir_output = "~/Work/hcocena/analyses/")

```


  The following function assures that all directories given above exist and fixes missing slashes at the end. It requires no parameters. If a directory does not exist (might just be a typo!) it will produce an error.


```{r check directories}
check_dirs()
```


  In this step we are going to choose a name for the folder that hCoCena creates for our analysis (in the directory that we set in init_wd: dir_output).
Since this is a showcase of the tool, I'll call it 'showcase':
  
  
```{r, warning = FALSE}

init_save_folder(name = "showcase")

```


## Defining layers

  For detailed information regarding the structures of the count and annotation data as well as different options for providing data, refer to the function documentation by entering ?hcocena::define_layers into the console.
    
```{r defining Omics Layers}
# NOTE: We are loading the data from existing R objects, that you will find in the stat_envo.RData, which you will have to load before running this cell.

define_layers(list( Array = c("data_array", "annotation_array"),
                   RNA_Seq = c("data_seq", "annotation_seq") )
              )

set_supp_files(Tf = "TFcat.txt", 
               Hall = "h.all.v6.1.symbols.gmt", 
               Go = "c5.bp.v7.0.symbols.gmt")

```


  

## Define global settings

  For detailed information regarding the different settings, enter ?hcocena::set_global_settings into the console.

```{r global settings}

set_global_settings(organism = "human", 
    								control_keyword = "none", 
    								variable_of_interest = "merged", 
    								min_nodes_number_for_network = 25, 
    								min_nodes_number_for_cluster = 25,
    								range_GFC = 2.0,
    								layout_algorithm = "layout_with_fr",
    								data_in_log = T)

```



## Data import

  For detailed information regarding the different parameters, enter ?hcocena::read_data into the console.


```{r data import}

read_data()

read_supplementary()

```


## OPTIONAL: Data-Based Definition of Top Most Variant Genes

Find inflection points in the ranked variances to filter for the top most variant genes in a data-driven way. 

## Define layer-specific settings

  For detailed information regarding the different settings, enter ?hcocena::set_layer_settings into the console.
  

```{r layer-specific settings}

# 7700 and 7664 are selected based on suggestions by the suggest_topvar() function in the satellite markdown
set_layer_settings(top_var = c(7700, 7664), 
                                     min_corr = rep(0.9, length(hcobject[["layers"]])), 
                                     range_cutoff_length = rep(50, length(hcobject[["layers"]])),
                                     print_distribution_plots = rep(F, length(hcobject[["layers"]])))


```



## OPTIONAL: Visualizing data distribution

  There is an option to plot the distribution of counts for each sample to check for outliers or prominent differences between samples. To do so, refer to "Checking data distribution" in the satellite markdown.
  
  
## OPTIONAL: PCA

  You can visualize your data in a PCA. To do so, please refer to the satellite markdown, section "PCA".
  

## Data processing part I

  For detailed information on what happens in this step and what parameters can be set, please refer to the section "Data processing part I" in the information file.
  

```{r expression analysis up to cutoff}

run_expression_analysis_1(corr_method = "spearman")

```

## Data processing part II


  Choosing the cut-offs:

  Set a correlation cut-off for each of your data sets. To aid this choice, the following plot presents the different cut-off statistics per data set. For more details on cut-offs and the information in this plot as well as the parameters, refer to the information file, section "Choosing the cut-offs".
  
  
```{r fig.height = 8, fig.width = 10}

plot_cutoffs(interactive = T)

```
  
  
  The order in which the cutoffs are subsequently defined must correspond to the order in which the layers have previously been specified.
  

```{r choose cutoff}

set_cutoff(cutoff_vector = c(0.7,0.7))

```


  Checking the scale-free topology

  For each dataset, the logged degree distribution and the linear regression are plotted to visualise the preservation of the scale-free topology criterion.


```{r plot degree distribution for chosen cutoff, message = F, warning = F}

plot_deg_dist()

```


  Heatmap of top most variant genes and GFC calculation

  For detailed information on what happens in this step as well as on the parameter settings, please refer to the section on "Data processing part II" in the information file.


```{r, fig.width = 10, fig.height = 7}

run_expression_analysis_2()

```

# Integration Phase

## Layer integration

  Integrating the layer-specific networks
  
  Here, the previously constructed layer-specific networks will be integrated into one network that combines the information. The integration can be based on the union or intersection of layer-specific networks and edges that are present in several networks at different length can be included based on different options. For detailed information, please refer to the information file, section "Layer integration".
  
```{r merge networks}

build_integrated_network(mode = "u", multi_edges = "min")

```

  

# Post-Integration Phase

## Module detection

  Clustering the network
  
  In this step, modules of strong co-expression will be detected in the network and their expression pattern across conditions will be represented in a GFC heatmap. For detailed information on module detection and different parameter settings, refer to the "Module detection" section in the information file.
  NOTE: You can export your clustering for future use. To do so, please refer to the satellite script, section "Export clustering".
  NOTE 2: Instead of clustering your network here, you can alternatively import a clustering model. To do so, please use the import_clusters() function (see satellite markdown for infos).
  
```{r compute clusters and plot module heatmap}
cluster_calculation(no_of_iterations = 50)
plot_cluster_heatmap()
```


## OPTIONAL: correlate numeric or categorical meta data with clusters

  To see how numeric or categorical meta information correlates to the expression patterns of a cluster, refer to the satellite markdown, section "Correlate numeric meta data with clusters" and "Correlate categorical meta data with clusters", respectively.


## Plotting the network coloured by module

NOTE: due to issues in the communication between R and Cytoscape, please refer to the satellite markdown, section "Cytoscape" if you chose Cytoscape as the option for the network layout in your global settings.


```{r plot network coloured by cluster, fig.width=10, fig.height=7}
# Cytoscape option used (see satellite markdown)
#plot_integrated_network() 

```


## OPTIONAL: Cluster scores

  If you would like to evaluate how well each gene belongs to its asserted cluster, please refer to the satellite markdown, section "Cluster scores".
  

## OPTIONAL: Hub gene detection

  Hub gene detection is available for clusters or the entire network. Please refer to the satellite markdown, section "Hub gene detection".
  

## OPTIONAL: Colour single cluster

  You can plot the network with a cluster of interest highlighted (colour and node size), using the chunk in the satellite markdown in section "Colour single cluster".
  

## OPTIONAL: Visualize specific gene set

  You can plot the mean expression values per condition for a list of genes as a heatmap.
  You find the corresponding function in the satellite markdown under "Visualize specific gene set".
  
  
## OPTIONAL: Colour specific gene set

  You further have the option of replotting the network and highlighting a particular gene set. To do so, please refer to the satellite markdown, section "Colour specific gene set".


## OPTIONAL: Evaluating the different community detection algorithms

  If you want to compare the default louvain clustering to other algorithms, please refer to the section "Evaluating different community detection algorithms" in the satellite markdown.
  
  
## OPTIONAL: Regrouping samples

  If you noticed that the variable of interest ("voi") does not go well with the clustering of the heatmaps returned by "run_expression_analysis_2" or as seen in the PCA, when evaluating different clustering algorithms, you can assign new group labels to your samples based on the data structure rather than meta information. In this case, please refer to the section "Regrouping samples" in the satellite markdown.
  

## OPTIONAL: Module analysis and meta-annotation

  You have the option to analyse the genes present in the found modules with regard to shared functionality or enriched gene sets as well as to annotate the groups of samples with meta information from your annotation file. To do so, please refer to the satelite markdown, section "Module analysis and meta-annotation".
  

## OPTIONAL: Final module heatmap and network

  If you regrouped your samples AND/OR conducted any steps in the "Module analysis and meta-annotation"-section, the heatmap will be replotted updated with respect to the grouping and annotation information along with the network coloured by modules. Of You have neither regrouped your sample nor analysed your modules or samples groups, this chunk will provide the exact same output as the previous one and can be skipped. 
  For detailed information on which parameters are available here and how to set them, please refer to the information file, section "Plotting the final heatmap".
  
```{r create cluster heatmap, fig.width = 10, fig.height = 7}

plot_cluster_heatmap()

plot_integrated_network(layout = hcobject[["integrated_output"]][["cluster_calc"]][["layout"]], 
                        save = F)

```

## OPTIONAL: Replotting of heatmap with different variable of interest

  In case you are uncertain if the "voi" you have initially chosen is the right choice for your analysis, you are given the opportunity to replot the final module heatmap based on a different annotation variable. To do so, please refer to the section "Replotting of heatmap with different variable of interest" in the satellite markdown.


## OPTIONAL: Plotting network coloured by GFC

  You can re-plot the network for each condition colouring the nodes according to their GFC in the different conditions. To do so, please refer to the section "Plotting network coloured by GFC" in the satellite markdown.
  
  
## Database enrichment

  Enrichment analysis of the found modules using the GO, KEGG, Hallmark and Reactome databases. For detailed information on parameter settings, please refer to the information file, section "Database enrichment".
  The outputs all have a slot called "enrichment", that contains the clusterProfiler enrich-object for each cluster. This can be used as input for further clusterProfiler visualisations. Please refer to the clsuterProfiler documentation.
  
```{r GO profiling, fig.width = 10, fig.height = 7, message = F, warning = F}

go_profiling(level = 4, top = 5, ont = "BP", fast = F, 
             clusters = c("turquoise", "lightblue", "gold", "darkorange", "plum", "orchid", "wheat", "lightgreen"), qval = 0.1)

# kegg_profiling(top = 5, 
#              clusters = c("turquoise", "lightblue", "gold", "darkorange", "plum", "orchid", "wheat", "lightgreen", "sandybrown"), qval = 0.1)

Hallmark_profiling(top = 5, 
             clusters = c("turquoise", "lightblue", "gold", "darkorange", "plum", "orchid", "wheat", "lightgreen"), qval = 0.1)

# reactome_profiling(top = 5, 
#              clusters = c("turquoise", "lightblue", "gold", "darkorange", "plum", "orchid", "wheat", "lightgreen", "sandybrown"), qval = 0.1)

```


## Transcription factor enrichment analyses with ChEA3

  Transcription factor enrichment analysis for each module and for the entire network based on ChEA3 (Kennan AB, 2019). For more details, refer to the information file, section "Transcription factor enrichment analyses with ChEA3". The plots can be found in the save folder, descriptions on how to read them can also be found in the mentioned information file section.
  
```{r , fig.width = 10, fig.height = 7}

TF_overrep()
TF_enrich_all(topTF = 100, topTarget = 30)

plot_TF_enrichment()

```
  
## OPTIONAL: Transcription factor query

  To query the output of the "TF_enrich_all()" function for a specific transcription factor, please refer to the satellite markdown, section "Transcription factor query". 
  





